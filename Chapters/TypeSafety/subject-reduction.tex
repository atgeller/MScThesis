\section{Subject Reduction}

\begin{theorem}{Subject Reduction}
  Bla bla bla
\end{theorem}
\begin{proof}
By case analysis on the reduction rules.
\todo{I want to omit locals and globals, but I also think it's good to keep them for completeness.}
Note that the locals and globals are omitted where they are unnecessary and trivially unchanged.

\thought{I'm like 90\% sure that a good chunk of these proofs are only understandable by me, to the extent that I understand what I'm doing.}

\thought{I keep appealing to basically an inversion lemma that is never stated but seems obvious. It would be a good idea to formalize this eventually (shouldn't be too difficult). In the meanwhile assume I mean that when I say "by x, we know y" where y is not a premise of the typing rule x or where I say "y is of the form z".}

\todo{Type rule names based on code from William's dissertation to match those used here}

\begin{itemize}
    %% Binop -> const
    \item $C\vdash (t.\<const> c_1)\; (t.\<const> c_2)\; t.\<binop> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$ 
    \\ $\land$ $(t.\<const> c_1)\; (t.\<const> c_2)\; t.\<binop> \hookrightarrow t.\<const> c$ if $c=\<binop>(c_1,c_2)$

        By $const$ and $binop$, we know that $s_2$ has the form $s_1 \ti{t}{a_3}$ and that
        \begin{align*}
            \phi_1&, 
            \begin{stackTL}
                \ti{t}{a_1}, (\<eq> a_1\;\ti{t}{c_1}), \\
                \ti{t}{a_2}, (\<eq> a_2 (t c_2)), \\
                \ti{t}{a_3}, (\<eq> a_3\;(\<binop>\; a_1\; a_2))
            \end{stackTL} \\    
            &\implies \phi_2
        \end{align*}

        By $const$, $C \vdash t.\<const> c :
            \begin{stackTL}
                \epsilon;l_1;g_1;\phi_1 \\ 
                \rightarrow \ti{t}{a_3};l_1;g_1;\phi_1,\ti{t}{a_3},(\<eq> a_3\;\ti{t}{c})
            \end{stackTL}$.

        Because $c=binop_t(c_1,c_2)$, then by $\implies$,
        \begin{align*}
            \phi_1,\ti{t}{a},(\<eq> a\;\ti{t}{c}) &\implies \phi_1,
            \begin{stackTL}
                \ti{t}{a_1}, (\<eq> a_1\; \ti{t}{c_1}), \\
                \ti{t}{a_2}, (\<eq> a_2\; \ti{t}{c_2}), \\
                \ti{t}{a_3}, (\<eq> a_3\;(\<binop>\;a_1 a_2))
            \end{stackTL}
        \end{align*}

        Therefore, $C \vdash (t.\<const> c) : s_1;l_1;g_1;\phi_1 \rightarrow s_1\; \ti{t}{a_3};l_1;g_1;\phi_2$, by $stack-poly$ and $weakening$

    %% Binop -> trap
    \item  $C\vdash (t.\<const> c_1)\; (t.\<const> c_2)\; t.\<binop> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $(t.\<const> c_1)\; (t.\<const> c_2)\; t.\<binop> \hookrightarrow \<trap>$

        Trivially, $C\vdash \<trap> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$ by $trap$.

    %% Relop
    \item $C\vdash (t.\<const> c_1)\; (t.\<const> c_2)\; t.\<relop> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\$\land$ $(t.\<const> c_1)\; (t.\<const> c_2)\; t.\<relop> \hookrightarrow t.\<const> c$ if $c=\<relop>(c_1,c_2)$

        \todo{I think right now it gets translated a little differently because the redex-model typing rule expands the index constraint a bit more to resemble what gets passed to Z3. I think this is better to fix in the redex-model so it resembles WASM execution more closely than Z3 constraints.}
        Similar to $\<binop>$.

    %% Testop
    \item $C\vdash (t.\<const> c)\; t.\<testop> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$ 
    \\ $\land$ $(t.\<const> c)\; (t.\<const> c)\; t.\<testop> \hookrightarrow t.\<const> c_2$ where $c_2=\<testop>(c)$

        By $const$ and $testop$, we know that $s_2$ has the form $s_1 \ti{t}{a_2}$, $l_2=l_1$, $g_2=g_1$, and that
        \begin{align*}
            \phi_1&, 
            \begin{stackTL}
                \ti{t}{a_1}, (\<eq> a_1\;\ti{t}{c}), \\
                \ti{t}{a_2}, (\<eq> a_2\;(\<testop>\;a_1))
            \end{stackTL} \\
            &\implies \phi_2
        \end{align*}

        By $const$, $C \vdash t.\<const> c :
            \begin{stackTL}
                \epsilon;l_1;g_1;\phi_1 \\ 
                \rightarrow \ti{t}{a_2};l_1;g_1;\phi_1,\ti{t}{a_2},(\<eq> a_2\;\ti{t}{c_2})
            \end{stackTL}$.

        Because $c_2=testop_t(c)$, then by $\implies$,
        \begin{align*}
            \phi_1,\ti{t}{a},(\<eq> a\;\ti{t}{c_2}) &\implies \phi_1,
            \begin{stackTL}
                \ti{t}{a_1}, (\<eq> a_1\;\ti{t}{c}), \\
                \ti{t}{a_2}, (\<eq> a_2\;(\<testop>\;a_1))
            \end{stackTL}
        \end{align*}

    %% Unreachable
    \item $C\vdash \<unreachable> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $\<unreachable> \hookrightarrow \<trap>$
    
        Trivially, $C\vdash \<trap> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$ by $trap$.

    %% Nop
    \item $C\vdash \<nop> : \epsilon;l;g;\phi \rightarrow \epsilon;l;g;\phi$ 
    \\ $\land$ $\<nop> \hookrightarrow \epsilon$
    
        Trivially, $C\vdash \epsilon : \epsilon;l;g;\phi \rightarrow \epsilon;l;g;\phi$ by $empty$. \todo{Not quite this trivial: what about extension and weakening?}

    %% Drop
    \item $C\vdash (t.\<const> c)\; \<drop> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $(t.\<const> c)\; \<drop> \hookrightarrow \epsilon$

        By $const$ and $drop$, we know that $s_2 = s_1$, $l_2 = l_1$, $g_2 = g_1$, and $\phi_1 \implies \phi_2$.

        By $empty$, $C\vdash \epsilon : \epsilon;l_1;g_1;\phi_1 \rightarrow \epsilon;l_1;g_1;\phi_1$

        By $stack-poly$, $C\vdash \epsilon : s_1;l_1;g_1;\phi_1 \rightarrow s_1;l_1;g_1;\phi_1$

        Since $\phi_1 \implies \phi_2$, then $C\vdash \epsilon : s_1;l_1;g_1;\phi_1 \rightarrow s_1;l_1;g_1;\phi_2$ by $weakening$.

    %% Select
    \item Case: $C\; {\begin{stackTL}
        \vdash (t.\<const> c_1)\;(t.\<const> c_2)\;(\<ithreetwo>.\<const> 0)\;\<select> 
        \\ : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2
    \end{stackTL}}$
    \\ $\land$ $(t.\<const> c_1)\;(t.\<const> c_2)\;(\<ithreetwo>.\<const> 0)\;\<select> \hookrightarrow (t.\<const> c_2)$

        By $const$ and $select$, we know that $s_2$ has the form $s_1\;\ti{a_3}$, $l_2 = l_1$, $g_2 = g_1$, and
        $
        {\begin{stackTL}
            \phi_1, {\begin{stackTL}
                \ti{t}{a_1}, (\<eq> a_1\;\ti{t}{c_1}), \\
                \ti{t}{a_2}, (\<eq> a_2\;\ti{t}{c_2}), \\
                \ti{\<ithreetwo>}{a}, (\<eq> a\;\ti{\<ithreetwo>}{0}), \\
                \ti{t}{a_3}, (
                {\begin{stackTL}
                    (\<eqz> a) \land (\<eq> a_3\;a_2)) \\
                    \lor (\neg(\<eqz> a) \land (\<eq> a_3\;a_1)))
                \end{stackTL}} \\
            \end{stackTL}} \\
            \implies \phi_2
        \end{stackTL}}
        $
        
        By $const$, \\
        $ C \vdash (t.\<const> c_2) :
            {\begin{stackTL}
                \epsilon;l_1;g_1;\phi_1 \\
                \rightarrow \ti{t}{a_3};l_1;g_1;\phi_1,\ti{t}{a_3},(\<eq> a_3\; \ti{t}{c_2}) \\
            \end{stackTL}} $

        Then, by $stack-poly$,\\
        $ C \vdash (t.\<const> c_2) : 
            {\begin{stackTL}
                s_1;l_1;g_1;\phi_1 \\
                \rightarrow s_1\;\ti{t}{a_3};l_1;g_1;\phi_1,\ti{t}{a_3},(\<eq> a_3 \; \ti{t}{c_2}) \\
            \end{stackTL}} $

        By $implies$, we have \\
        $\phi_1,\ti{t}{a_3},(\<eq> a_3\; \ti{t}{c_2}) \implies \phi_1, {\begin{stackTL}
            \ti{t}{a_1}, (\<eq> a_1\; \ti{t}{c_1}), \\
            \ti{t}{a_2}, (\<eq> a_2\; \ti{t}{c_2}), \\
            \ti{\<ithreetwo>}{a}, (\<eq> a\;\ti{\<ithreetwo>}{0}), \\
            \ti{t}{a_3}, (
            {\begin{stackTL}
                (\<eqz> a) \land (\<eq> a_3\;a_2)) \\
                \lor (\neg(\<eqz> a) \land (\<eq> a_3\;a_1)))
            \end{stackTL}} \\
        \end{stackTL}} \\$

        Therefore,
        $ C \vdash (t.\<const> c_2) :
            s_1;l_1;g_1;\phi_1 
            \rightarrow s_1\;\ti{t}{a_3};l_1;g_1;\phi_2$, by $weakening$

    %% Block
    \item Case: $C \vdash v^n \; \<block> tfi \; e^{*} \<end> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $v^n \; \<block> tfi \; e^{*} \<end> \hookrightarrow \<label>_m \{ \epsilon \} \; v^n \; e^{*} \<end>$

        \thought{Technically we can't yet have $\ti{t}{a}^n=ti_1^{n}$ as we will derive that by $composition$ on $const$ and $block$. However, I'm lazy and will address this later because it is a minor detail and I want to focus on major details right now.}

        Let $ti_1^n;l_3;g_3;\phi_3 \rightarrow ti_2^m;l_4;g_4;\phi_4=tfi$, $(t.\<const> c)^n=v^n$, and $\ti{t}{a}^n=ti_1^{n}$.

        $C \vdash (t.\<const> c)^n : \epsilon;l_1;g_1;\phi_1 \rightarrow \\ \; \ti{t}{a}^n;l_1;g_1;\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n$ by $const$.

        $C \vdash (t.\<const> c)^n : s_1;l_1;g_1;\phi_1 \rightarrow \\ \; s_1\; \ti{t}{a}^n;l_1;g_1;\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n$ by $stack-poly$.
    
        $C \vdash \<block> tfi \; e^{*} \<end> : s_1 \; \ti{t}{a}^n;l_1;g_1;\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n \rightarrow s_2;l_2;g_2;\phi_2$ by $composition$.

        \todo{1: we should derive $l_1=l_3$,$g_1=g_3$, etc... and 2: add a parenthetical about usage}.

        $C \vdash \<block> tfi \; e^{*} \<end> : s_1 \; \ti{t}{a}^n;l_1;g_1;\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n \rightarrow s_1\; ti_2^{m};l_2;g_2;\phi_2$ by inversion, and therefore $s_2=s_1\; ti_2^{m}$.

        Further, $\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n \implies \phi_3$ by $weakening$, and $\phi_4 \implies \phi_2$ by $block$ and $weakening$.

        $C,\text{label}(t_2^{m};l_4;g_4;\phi_4) \vdash (t.\<const> c)^n : \epsilon;l_1;g_1;\phi_1 \rightarrow \\ \ti{t}{a}^n;l_1;g_1;\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n$ by $const$.

        $C,\text{label}(t_2^{m};l_4;g_4;\phi_4) \vdash e^{*} : ti_1^n;l_1;g_1;\phi_3 \rightarrow ti_2^m;l_4;g_4;\phi_4$ because it is a sub-derivation of $block$ which we have already assumed to hold.

        Then $C,\text{label}(t_2^{m};l_4;g_4;\phi_4) \vdash (t.\<const> c)^n\; e^{*} : \epsilon;l_1;g_1;\phi_1 \rightarrow \\ ti_2^m;l_4;g_4;\phi_4$ by $composition$.

        By $empty$ and $stack-poly$, $C \vdash \epsilon : ti_2^m;l_4;g_4;\phi_4 \rightarrow ti_2^m;l_4;g_4;\phi_4$.

        Therefore, $C \vdash \<label>_m \{ \epsilon \} \; v^n \; e^{*} \<end> : \epsilon;l_1;g_1;\phi_1 \rightarrow ti_2^m;l_4;g_4;\phi_4$ by $label$.

        Since $s_2 = s_1\; ti_2^m$, $l_2 = l_4$, $g_2 = g_4$, and $\phi_4 \implies \phi_2$, then by $stack-poly$ and $weakening$ we have: $C \vdash \<label>_m \{ \epsilon \} \; v^n \; e^{*} \<end> : s_1;l_1;g_1;\phi_1 \rightarrow ti_2^m;l_2;g_2;\phi_2$

    \item Case: $C \vdash v^n \; \<loop> tfi \; e^{*} \<end> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $v^n \; \<loop> tfi \; e^{*} \<end> \hookrightarrow \<label>_n \{ \<loop> tfi \; e^{*} \<end> \} \; v^n \; e^{*} \<end>$

        \thought{Same as above about $\ti{t}{a}^n=ti_1^{n}$.}

        Let $ti_1^n;l_3;g_3;\phi_3 \rightarrow ti_2^m;l_3;g_3;\phi_4=tfi$, $(t.\<const> c)^n=v^n$, and $\ti{t}{a}^n=ti_1^{n}$.

        $C \vdash (t.\<const> c)^n : \epsilon;l_1;g_1;\phi_1 \rightarrow \\ \; \ti{t}{a}^n;l_1;g_1;\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n$ by $const$.

        $C \vdash (t.\<const> c)^n : s_1;l_1;g_1;\phi_1 \rightarrow \\ \; s_1\; \ti{t}{a}^n;l_1;g_1;\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n$ by $stack-poly$.
    
        $C \vdash \<loop> tfi \; e^{*} \<end> : s_1 \; \ti{t}{a}^n;l_1;g_1;\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n \rightarrow s_2;l_2;g_2;\phi_2$ by $composition$, and therefore $l_1=l_3$ and $g_1=g_3$ (Note: since $l_1=l_3$ and $g_1=g_3$, I will use $l_1$ and $g_1$ in place of $l_3$ and $g_3$, respectively, for the rest of the proof).

        \thought{Do we need this next type rule statement? We can just get rid of it and have ``By inversion ...''}

        $C \vdash \<loop> tfi \; e^{*} \<end> : s_1 \; \ti{t}{a}^n;l_1;g_1;\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n \rightarrow s_1\; ti_2^{m};l_2;g_2;\phi_2$ by inversion, and therefore $s_2=s_1\; ti_2^{m}$, $l_4=l_2$, and $g_4=g_2$ (Note: since $l_2=l_4$ and $g_2=g_4$, I will use $l_4$ and $g_4$ in place of $l_2$ and $g_2$, respectively, for the rest of the proof).

        Further, $\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n \implies \phi_3$ by $weakening$, and $\phi_4 \implies \phi_2$ by $loop$ and $weakening$.

        $C,\text{label}(t_1^{n};l_1;g_1;\phi_1) \vdash (t.\<const> c)^n : \epsilon;l_1;g_1;\phi_1 \rightarrow \\ \ti{t}{a}^n;l_1;g_1;\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n$ by $const$.

        $C,\text{label}(t_1^{n};l_1;g_1;\phi_1) \vdash e^{*} : ti_1^n;l_1;g_1;\phi_3 \rightarrow ti_2^m;l_1;g_1;\phi_4$ because it is a sub-derivation of $loop$ which we have already assumed to hold.

        Then $C,\text{label}(t_1^{n};l_1;g_1;\phi_1) \vdash (t.\<const> c)^n\; e^{*} : \epsilon;l_1;g_1;\phi_1 \rightarrow \\ ti_2^m;l_4;g_4;\phi_4$ by $composition$.

        $C \vdash \<loop> tfi \; e^{*} \<end> : \ti{t}{a}^n;l_1;g_1;\phi_1,\ti{t}{a}^n,(\<eq> a \; \ti{t}{c})^n \rightarrow ti_2^{m};l_4;g_4;\phi_4$ by $loop$.

        Therefore, $C \vdash \<label>_m \{ \<loop> tfi \; e^{*} \<end> \} \; v^n \; e^{*} \<end> : \epsilon;l_1;g_1;\phi_1 \rightarrow ti_2^m;l_4;g_4;\phi_4$ by $label$.

        Since $s_2 = s_1\; ti_2^m$, $l_2 = l_4$, $g_2 = g_4$, and $\phi_4 \implies \phi_2$, then by $stack-poly$ and $weakening$ we have: $C \vdash \<label>_m \{ \epsilon \} \; v^n \; e^{*} \<end> : s_1;l_1;g_1;\phi_1 \rightarrow ti_2^m;l_2;g_2;\phi_2$

    \item Case: $C \vdash (\<ithreetwo>.\<const> 0) \; \<if> tfi \; e_1^{*} \<else> e_2^{*} \<end> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $(\<ithreetwo>.\<const> 0) \; \<if> tfi \; e_1^{*} \<else> e_2^{*} \<end> \hookrightarrow \<block> tfi \; e_2^{*} \<end>$

        Let $tfi = ti_1^n \; \ti{<ithreetwo>}{a};l_3;g_3;\phi_3 \rightarrow ti_2^m;l_4;g_4;\phi_4$, \\ $tfi_1 = ti_1^n;l_3;g_3;\phi_3,\neg(\<eqz> a) \rightarrow ti_2^m;l_4;g_4;\phi_4$, \\
        and $tfi_2 = ti_1^n;l_3;g_3;\phi_3,(\<eqz> a) \rightarrow ti_2^m;l_4;g_4;\phi_4$.

        $C \vdash \<if> tfi \; e_1^{*} \<else> e_2^{*} \<end> : tfi_1$ by $if$.

        By $inversion$, $s_1=s \; ti_1^{n}$ and $s_2=s \; ti_2^{m}$ for some $s$, $l_1=l_3$, $g_1=g_3$, $l_2=l_4$, $g_2=g_4$, $\phi_1,\ti{\<ithreetwo>}{a},(\<eq> a\; 0) \implies \phi_3$, and $\phi_4 \implies \phi_2$.

        \todo{Might want to spell this out a bit more, there's like three different levels of $inversion$ used to get here, which is valid but might be overly obfuscated}

        $C,\text{label}(ti_2^m;l_4;g_4;\phi_4) \vdash e_2^{*} : tfi_2$ because it is a sub-derivation of $if$ which we have assumed to hold by $inversion$.

        Then, $C \vdash \<block> tfi_2 \; e_2^{*} \<end>$ by $block$.

        \thought{We can appeal to implication because $\ti{\<ithreetwo>}{a}$ is freshly introduced by $const$, this is an important point that should be mentioned somewhere, also, since $a$ is fresh, we know this won't cause a contradiction in $\phi$}.

        \thought{That being said, maybe we want use $\equiv$ instead of $\implies$ to handle this just as a presentation detail.}

        $\phi_1 \implies \phi_1,\ti{t}{a},(\<eqz> a)$ by $\implies$.

        Therefore, $C \vdash \<block> tfi_2\; e_2^{*} \<end> : \\ s \; ti_1^n;l_1;g_1;\phi_1,\ti{t}{a},(\<eqz> a) \rightarrow s\; ti_2^m;l_2;g_2;\phi_2$ by $extension$ and $weakening$.

    \item Case: $C \vdash (\<ithreetwo>.\<const> k+1) \; \<if> tfi \; e_1^{*} \<else> e_2^{*} \<end> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $(\<ithreetwo>.\<const> k+1) \; \<if> tfi \; e_1^{*} \<else> e_2^{*} \<end> \hookrightarrow \<block> tfi \; e_1^{*} \<end>$

        Similar to above.

    \item Case: $C \vdash \<label>_n \{ e^{*} \} \; v^n \<end> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $\<label>_n \{ e^{*} \} \; v^n \<end> \hookrightarrow v^n$

        $C \vdash \<label>_n \{ e^{*} \} \; v^n \<end> : \epsilon;l_1;g_1;\phi_1 \rightarrow ti_2^{*};l_2;g_2;\phi_2$ by $label$ and $inversion$.

        By $inversion$, we know $s_2=s_1\;ti_2^{*}$.

        $C \vdash v^n : \epsilon;l_1;g_1;\phi_1 \rightarrow ti_2^{*};l_2;g_2;\phi_2$ because it is a premise of $label$ which we have assumed to hold.

        Therefore, $C \vdash v^n : s_1;l_1;g_1;\phi_1 \rightarrow s_1\; ti_2^{*};l_1;g_1;\phi_2$ by $stack-poly$.

    \item Case: $C \vdash \<label>_n \{ e^{*} \} \; \<trap> \<end> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $\<label>_n \{ e^{*} \} \; \<trap> \<end> \hookrightarrow \<trap>$

        Trivially, $C\vdash \<trap> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$ by $trap$.

    \item Case: $C \vdash \<label>_n \{ e^{*} \} \; L^k [v^n \; (\<br> j)] \<end> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $\<label>_n \{ e^{*} \} \; L^k [v^n \; (\<br> j)] \hookrightarrow v^n \; e^{*}$

        \thought{Intuitively, this follows because \<br> is typed based on the label in $C$ from the $label$ rule, and everything follows from that. I'm not sure exactly how hand-wavy I can get away with being describing that though.}

        \todo{The original \wasm proof addresses this using a lemma about labels which will be easy to recreate. In the meantime I will refer to that (which is the precise description of what I just said).}

        By $inversion$, $s_2=s_1\;ti_2^{*}$.

        $C,\text{label}(ti_1^n;l_1;g_1;\phi_3)^j \vdash v^n\; (\<br> j) : \epsilon;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$ since it is a premise of $label$ which we have assumed to hold.

        $C,\text{label}(ti_1^n;l_1;g_1;\phi_3)^j \vdash (\<br> j) : ti_1^n;l_1;g_1;\phi_3 \rightarrow s_2;l_2;g_2;\phi_2$, by $label-filled$.

        Then, $C,\text{label}(ti_1^n;l_1;g_1;\phi_3)^j \vdash v^n : \epsilon;l_1;g_1;\phi_1 \rightarrow ti_1^n;l_1;g_1;\phi_3$ since it is a premise of $composition$ which we have assumed to hold.

        $C \vdash e^{*} : ti_1^n;l_1;g_1;\phi_3 \rightarrow ti_2^{*};l_2;g_2;\phi_4$ since it is a premise of $label$ which we have assumed to hold, and $\phi_4 \implies \phi_2$ by $inversion$.

        Then, $C \vdash v^n \; e^{*} : \epsilon;l_1;g_1;\phi_1 \rightarrow ti_2^{*};l_2;g_2;\phi_4$ by $composition$.

        Finally, $C \vdash v^n \; e^{*} : s_1;l_1;g_1;\phi_1 \rightarrow s_1\;ti_2^{*};l_2;g_2;\phi_2$ by $stack-poly$ and $weakening$.

    \item Case: $C \vdash (\<ithreetwo>.\<const> 0)\;(\<brif> j) : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $(\<ithreetwo>.\<const> 0)\;(\<brif> j) \hookrightarrow \epsilon$

        By $br \_ if$, $C \vdash (\<brif> j) : s_1\; \ti{\<ithreetwo>}{a};l_1;g_1;\phi_1,\ti{t}{a},(\<eq> a\; \ti{\<ithreetwo>}{0}) \rightarrow s_1;l_1;g_1;\phi_1,\ti{t}{a},(\<eq> a\; \ti{\<ithreetwo>}{0}),(\<eqz> a)$.

        $C \vdash (\<ithreetwo>.\<const> 0) : s_1;l_1;g_1;\phi_1 \rightarrow s\;\ti{\<ithreetwo>}{a};l;g;\phi,\ti{\<ithreetwo>}{a},(\<eq> a\; \ti{\<ithreetwo>}{0})$ by $const$.

        By $composition$, $C \vdash (\<ithreetwo>.\<const> 0)\;(\<brif> j) : s_1;l_1;g_1;\phi_1 \rightarrow s_1;l_1;g_1;\phi_1,\ti{\<ithreetwo>}{a},(\<eq> a\; \ti{\<ithreetwo>}{0}),(\<eqz> a)$.

        Then, by $inversion$, $s_1=s_2$, $l_1=l_2$, $g_1=g_2$, and $\phi_1,\ti{\<ithreetwo>}{a},(\<eq> a\; \ti{\<ithreetwo>}{0}),(\<eqz> a) \implies \phi_2$.

        $C \vdash \epsilon : \epsilon;l_1;g_1;\phi_1 \rightarrow \epsilon;l_1;g_1;\phi_1$ by $empty$.

        $C \vdash \epsilon : s_1;l_1;g_1;\phi_1 \rightarrow s_1;l_1;g_1;\phi_1$ by $stack-poly$.

        \thought{I'm not super keen on this way of presenting because the two completely different universes used before and after reduction may be easily muddled into one by a reader. I think the key is to just be really explicit that these are two different type universes and different things fly in different places.}

        $\phi_1 \implies \phi_1,\ti{\<ithreetwo>}{a},(\<eq> a\; \ti{\<ithreetwo>}{0}),(\<eqz> a)$ because $a$ is fresh, and therefore $\phi_1 \implies \phi_2$.

        Then, $C \vdash \epsilon : s_1;l_1;g_1;\phi_1 \rightarrow s_1;l_1;g_1;\phi_2$ by $weakening$.

    \item Case: $C \vdash (\<ithreetwo>.\<const> k+1)\;(\<brif> j) : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$
    \\ $\land$ $(\<ithreetwo>.\<const> k+1)\;(\<brif> j) \hookrightarrow \<br> j$

        $C \vdash (\<ithreetwo>.\<const> k+1) : s_1;l_1;g_1;\phi_1 \rightarrow s\;\ti{\<ithreetwo>}{a};l;g;\phi,\ti{\<ithreetwo>}{a},(\<eq> a\; \ti{\<ithreetwo>}{k+1})$ by $const$.

        By $br \_ if$, $C \vdash (\<brif> j) : s_1\; \ti{\<ithreetwo>}{a};l_1;g_1;\phi_1,\ti{t}{a},(\<eq> a\; \ti{\<ithreetwo>}{k+1}) \rightarrow s_1;l_1;g_1;\phi_1,\ti{t}{a},(\<eq> a\; \ti{\<ithreetwo>}{k+1}),(\<eqz> a)$.

        \thought{We're not rederiving the type of $br\_if$ above, we already have it as part of the derivation.}

        By $composition$, $C \vdash (\<ithreetwo>.\<const> k+1)\;(\<brif> j) : s_1;l_1;g_1;\phi_1 \rightarrow s_1;l_1;g_1;\phi_1,\ti{\<ithreetwo>}{a},(\<eq> a\; \ti{\<ithreetwo>}{k+1}),(\<eqz> a)$.

        $C_label(j)=s_1;l_1;g_1;\phi_1,\ti{t}{a},\neq(\<eqz> a)$ because it is a side condition of $br\_if$ which we have assumed to hold by $inversion$.

        $C \vdash \<br> j : s_1;l_1;g_1;\phi_1,\ti{t}{a},\neq(\<eqz> a) \rightarrow s_2;l_2;g_2;\phi_2$ by $br$.

        Because $a$ is fresh, $\phi_1 \implies \phi_1,\ti{\<ithreetwo>}{a},\neg(\<eqz> a)$.

        Therefore, $C \vdash \<br> j : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$ by $weakening$.

    \item Case: $\<local>_n \{ i;v^{*}_l \} \; v^n \<end> \hookrightarrow_j \; v^n$

        \begin{itemize}
            \item Case: $i = j$
            \\ $\land$ $S;C \vdash_j s;v^{*};\<local>_n \{ j;v_l^{*} \} \; v^n \<end> : ti_1^{*};l_1;g_1;\phi_1 \rightarrow ti_2^{*};l_2;g_2;\phi_2$

                By $inversion$, $ti_2^{*}=ti_1^{*}\;ti^n$ and $l_1 = l_2$.

                $S;(ti^n;l_3;g_2;\phi_2) \vdash_j s;v_l^{*};v^n : ti^n;l_3;g_2;\phi_2$ because it is a premise of $local-same-inst$ which we have assumed to hold.

                $s;v_l^{*} \models_i l_4;g_3;\phi_3$, and\\
                $S;C_l \vdash_i s;v_l^{*};v^n : \epsilon;l_4;g_3;\phi_3 \rightarrow ti^n;l_3;g_2;\phi_2$ because they are premises of $admin-code$ which we have assumed to hold.

                By $state-models$, $\phi_3 = \circ,\ti{t_{vl}}{a_{vl}}^{*},(\<eq> a_{vl} \; \ti{t_{vl}}{c_{vl}})^{*},\ti{t_g}{a_g}^{*},(\<eq> a_g \; \ti{t_g}{c_g})^{*}$.

                By $inversion$ on $const$ and $subtyping$, $\phi_3,(\ti{t}{a},(\<eq> a \; \ti{t}{c}))^{*} \implies \phi_2$.

                \thought{Does this require a lemma? It holds no matter how subtyping appears in the derivation tree (or if it doesn't appear). (Diamond lemma?)}

                By $inversion$ on $const$, $S;C_l \vdash_i s;v_l^{*};v^n : \epsilon;l_3;g_2;\phi_3 \rightarrow ti^n;l_3;g_2;\phi_3,(\ti{t}{a},(\<eq> a \; \ti{t}{c}))^n$, and $l_4 = l_3$, $g_3 = g_2$.

                $S;C \vdash_i s;v^{*};v^n : \epsilon;l_2;g_2;\phi_3 \rightarrow ti^n;l_2;g_2;\phi_3,(\ti{t}{a},(\<eq> a \; \ti{t}{c}))$ by $const$.

                $S;C \vdash_i s;v^{*};v^n : \epsilon;l_2;g_2;\phi_3 \rightarrow ti^n;l_2;g_2;\phi_2$ by $subtyping$.

                By $???$, $\phi_1 = \phi_4,\ti{t_v}{a_v}^{*},(\<eq> a_v \; \ti{t_v}{c_v})^{*}$, where $\ti{t_v}{a_v}^{*} = ti_1^{*}$, and $s;v^{*} \models_j l_1;g_1;\phi_4$.

                \todo{This probably requires a lemma, claiming that the local must appear only after values, labels, and other locals, so the stack only has constants, the constraint store is structured a certain way, etc.}

                \thought{Because of $subtyping$, might need to claim that $\phi_1 \implies ...$ instead of $\phi_1 = ...$.}

                By $state-models$, $\phi_4 = \circ,\ti{t_l}{a_l}^{*},(\<eq> a_l \; \ti{t_l}{c_l})^{*},\ti{t_g}{a_g}^{*},(\<eq> a_g \; \ti{t_g}{c_g})^{*}$.

                Because $a_{vl}^{*}$ are fresh with respect to $l_2$ and $g_2$, $\circ,(\ti{t_g}{a_g},(\<eq> a_g \; \ti{t_g}{c_g})^{*} \implies \phi_3$.

                $S;C \vdash_i s;v^{*};v^n : \epsilon;l_2;g_2;\phi_1 \rightarrow ti^n;l_2;g_2;\phi_2$ by $subtyping$.

                \thought{Might be doing too much in a single step, using the above line and the ability to arbitrarily extend the store.}

                By $state-models$, $g_2 = \ti{t_g}{a_g}^{*}$, and $g_1 = \ti{t_g}{a_g}$, therefore $g_1 = g_2$.

                Therefore, $S;C \vdash_j s;v^{*};v^n : ti_1^{*};l_1;g_1;\phi_1 \rightarrow ti_2^{*};l_2;g_2;\phi_2$ by $stack-poly$.

            \item Case: $i \neq j$
            \\ $\land$ $S;C \vdash_j s;v^{*};\<local>_n \{ i;v_l^{*} \} \; v^n \<end> : ti_1^{*};l_1;g_1;\phi_1 \rightarrow ti_2^{*};l_2;g_2;\phi_2$

                By $inversion$, $ti_2^{*}=ti_1^{*}\;ti^n$, $l_1 = l_2$, and $g_2 = \ti{t_g}{a_g}^{*}$.

                $S;(ti^n;l_3;g_3;\phi_2) \vdash_i s;v_l^{*};v^n : ti^n;l_3;g_3;\phi_2$ because it is a premise of $local-diff-inst$ which we have assumed to hold.

                % $(\vdash v_l : ti_l;\phi_v)^{*}$\\ $\land$
                % $S;C_l \vdash_i s;v_l^{*};v^n : \epsilon;ti_l^{*};g_3;\phi_1,\phi_v^{*} \rightarrow ti_n;l_3;g_4;\phi_2$ because they are premises of $admin-code$ which we have assumed to hold.

                $s;v_l^{*} \models_i l_4;g_4;\phi_3$ and\\
                $S;C_l \vdash_i s;v_l^{*};v^n : \epsilon;l_4;g_4;\phi_3 \rightarrow ti^n;l_3;g_3;\phi_2$ because they are premises of $admin-code$ which we have assumed to hold.

                By $state-models$, $\phi_3 = \circ,\ti{t_{vl}}{a_{vl}}^{*},(\<eq> a_{vl} \; \ti{t_{vl}}{c_{vl}})^{*},\ti{t_g}{a_g}^{*},(\<eq> a_g \; \ti{t_g}{c_g})^{*}$.

                By $inversion$ on $const$ and $subtyping$, $\phi_3,(\ti{t}{a},(\<eq> a \; \ti{t}{c}))^{*} \implies \phi_2$.

                By $inversion$ on $const$, $S;C_l \vdash_i s;v_l^{*};v^n : \epsilon;l_3;g_3;\phi_3 \rightarrow ti^n;l_3;g_3;\phi_3,(\ti{t}{a},(\<eq> a \; \ti{t}{c}))^n$, and $l_4 = l_3$, $g_4 = g_3$.

                $S;C \vdash_j s;v^{*};v^n : \epsilon;l_2;g_2;\phi_3 \rightarrow ti^n;l_2;g_2;\phi_3,(\ti{t}{a},(\<eq> a \; \ti{t}{c}))$ by $const$.

                $S;C \vdash_j s;v^{*};v^n : \epsilon;l_2;g_2;\phi_3 \rightarrow ti^n;l_2;g_2;\phi_2$ by $subtyping$.

                By $???$, $\phi_1 = \phi_4,\ti{t_v}{a_v}^{*},(\<eq> a_v \; \ti{t_v}{c_v})^{*}$, where $\ti{t_v}{a_v}^{*} = ti_1^{*}$, and $s;v^{*} \models_j l_1;g_1;\phi_4$.

                \todo{Use the lemma once it exists.}

                \todo{Show that $s;v^{*} \models_j l_1;g_2;\phi_4$.}

        \end{itemize}

    \item Case: $S;C \vdash_j s;v^{*};\<local>_n \{ i;v_l^{*} \} \; \<trap> \<end> : ti_1^{*};l_1;g_1;\phi_1 \rightarrow ti_2^{*};l_2;g_2;\phi_2$
    \\ $\land$ $\<local>_n \{ i;v_l^{*} \} \; \<trap> \<end> \hookrightarrow \; \<trap>$

        Trivially, $S;C \vdash_j s;v^{*};\<trap> : ti_1^{*};l_1;g_1;\phi_1 \rightarrow ti_2^{*};l_2;g_2;\phi_2$ by $trap$.

    \item Case: $\<local>_n \{ i;v^{*}_l \} \; L^k[v^n \; \<return>] \<end> \hookrightarrow_j \; v^n$

        \begin{itemize}
            \item Case: $i = j$
            \\ $\land$ $S;C \vdash_j \<local>_n \{ j;v_l^{*} \} \; L^k[v^n \; \<return>] \<end> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$

                By $inversion$, $s_2=s_1\;ti^n$ and $l_1 = l_2$.

                $S;(ti^n;l_3;g_2;\phi_2) \vdash_j v_l^{*};L^k[v^n \; \<return>] : \epsilon;\epsilon;g_1;\phi_1 \rightarrow ti^n;l_3;g_2;\phi_2$ because it is a premise of $local-same-inst$ which we have assumed to hold.

                $(\vdash v_l : ti_l;\epsilon;\epsilon;\phi_v)^{*}$\\ $\land$
                $S;C_l \vdash_j L^k[v^n \; \<return>] : \epsilon;ti_l^{*};g_1;\phi_1,\phi_v^{*} \rightarrow ti^n;l_3;g_2;\phi_2$,
                where $C_l = S_\text{inst}(j),\text{local} \; t_v^{*}, \text{return} \; ti^n;l_3;g_2;\phi_2$
                because they are premises of $admin-code$ which we have assumed to hold.

                $\phi_v^{*} = \circ,(\ti{t}{a},(\<eq> a \; \ti{t}{c}))^{*}$, where $\ti{t}{a}^{*} = ti_l^{*}$, $(t.\<const> c)^{*} = v_l^{*}$ by $admin-const$.

                Because $a^{*}$ are fresh, $\phi_1 \implies \phi_1,(\ti{t}{a},(\<eq> a \; \ti{t}{c}))^{*}$.

                $S;C_l \vdash_j L^k[v^n \; \<return>] : \epsilon;ti_l^{*};g_1;\phi_1 \rightarrow ti^n;l_3;g_2;\phi_2$ by $weakening$.

                $S;C_l \vdash_j \<return> : s_3 \; ti^n;l_3;g_2;\phi_3 \rightarrow s_4;l_4;g_3;\phi_4$, and $\phi_3 \implies \phi_2$, by $inversion$ on $return$.

                $S;C_l \vdash_j v^n : s_5;l_5;g_4;\phi_5 \rightarrow s_3 \; ti^n;l_3;g_2;\phi_3$ because it is a premise of $composition$ which we have assumed to hold.

                By $inversion$ on $const$, $s_5 = s_3$.

                $S; C_l \vdash_j v^n : \epsilon;l_5;g_4;\phi_5 \rightarrow ti^n;l_3;g_2;\phi_3$ by $inversion$ on $stack-poly$.

                $S;C_l \vdash_j v^n : \epsilon;ti_l^{*};g_1;\phi_1 \rightarrow ti^n;l_3;g_2;\phi_3$, by (Nested-Type-Preserved).

                $S;C_l \vdash_j v^n : \epsilon;ti_l^{*};g_1;\phi_1 \rightarrow ti^n;l_3;g_2;\phi_2$ by $subtyping$.

                $S;C \vdash_j v^n : \epsilon;l_1;g_1;\phi_1 \rightarrow ti^n;l_2;g_2;\phi_2$ by $const$.

                Therefore, $S;C \vdash_j v^n : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$ by $stack-poly$.

            \item Case: $i \neq j$
            \\ $\land$ $S;C \vdash_j \<local>_n \{ i;v_l^{*} \} \; L^k[v^n \; \<return>] \<end> : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$

                By $inversion$, $s_2=s_1\;ti^n$ and $l_1 = l_2$.

                $S;(ti^n;l_3;g_4;\phi_2) \vdash_i v_l^{*};L^k[v^n \; \<return>] : \epsilon;\epsilon;g_3;\phi_1 \rightarrow ti^n;l_3;g_4;\phi_2$ because it is a premise of $local-diff-inst$ which we have assumed to hold.

                $(\vdash v_l : ti_l;\epsilon;\epsilon;\phi_v)^{*}$\\ $\land$
                $S;C_l \vdash_i L^k[v^n \; \<return>] : \epsilon;ti_l^{*};g_3;\phi_1,\phi_v^{*} \rightarrow ti^n;l_3;g_4;\phi_2$,
                where $C_l = S_\text{inst}(i),\text{local} \; t_v^{*}, \text{return} \; ti^n;l_3;g_4;\phi_2$.

                $\phi_v^{*} = \circ,(\ti{t}{a},(\<eq> a \; \ti{t}{c}))^{*}$, where $\ti{t}{a}^{*} = ti_l^{*}$, $(t.\<const> c)^{*} = v_l^{*}$ by $admin-const$.

                Because $a^{*}$ are fresh, $\phi_1 \implies \phi_1,(\ti{t}{a},(\<eq> a \; ti{t}{c}))^{*}$.

                $S;C_l \vdash_i L^k[v^n \; \<return>] : \epsilon;ti_l^{*};g_3;\phi_1 \rightarrow ti^n;l_3;g_4;\phi_2$ by $weakening$.

                $S;C_l \vdash_i \<return> : s_3 \; ti^n;l_3;g_4;\phi_3 \rightarrow s_4;l_4;g_5;\phi_4$, and $\phi_3 \implies \phi_2$ by $inversion$ on $return$.

                $S;C_l \vdash_i v^n : s_5;l_5;g_6;\phi_5 \rightarrow s_3 \; ti^n;l_3;g_4;\phi_3$ because it is a premise of $composition$ which we have assumed to hold.

                By $inversion$ on $const$, $s_5 = s_3$.

                $S;C_l \vdash_i v^n : \epsilon;l_5;g_6;\phi_5 \rightarrow ti^n;l_3;g_4;\phi_3$ by $inversion$ on $stack-poly$.

                $S;C_l \vdash_i v^n : \epsilon;ti_l^{*};g_3;\phi_1 \rightarrow ti^n;ti_l^{*};g_4;\phi_3$ by (Nested-Type-Preserved).

                $S;C_l \vdash_i v^n : \epsilon;ti_l^{*};g_3;\phi_1 \rightarrow ti^n;ti_l^{*};g_4;\phi_2$ by $subtyping$.

                $S;C \vdash_i v^n : \epsilon;l_1;g_1;\phi_1 \rightarrow ti^n;l_2;g_1;\phi_2$ by $const$.

                By $inversion$ and $local-diff-inst$, $g_2 = \ti{t}{a}^{*}$, where $a^{*}$ are fresh.

                $S;C \vdash_i v^n : \epsilon;l_1;g_1;\phi_1 \rightarrow ti^n;l_2;g_2;\phi_2$ by $fresh-globals$.

                \todo{Use the generic global information loss rule instead of $fresh-globals$ when we make it}.

                Therefore, $S;C \vdash_j v^n : s_1;l_1;g_1;\phi_1 \rightarrow s_2;l_2;g_2;\phi_2$ by $stack-poly$.

        \end{itemize}

\end{itemize}
\end{proof}
