\subsection{Lemmas Used in Subject-Reduction Proof}
\begin{lemma}{(Inversion)}
    \todo{So many cases to write out}

    %% const
    If $C \vdash t.\<const> c : ti_1^{*};l_1;\phi_1 \rightarrow ti_2^{*};l_2;\phi_2$,
    then $ti_2^{*} = ti_1^{*}\;\ti{t}{a}$, $l_1 = l_2$,
    and $\satisfies{\phi_1,\ti{t}{a},(= a \; \ti{t}{c})}{ti_2^{*}\;l_2}{\phi_2}$.

    %% binop
    If $C \vdash t.binop : ti_1^{*};l_1;\phi_1 \rightarrow ti_2^{*};l_2;\phi_2$,
    then $ti_1^{*} = ti^{*} \; \ti{t}{a_1} \; \ti{t}{a_2}$, $ti_2^{*} = ti^{*} \; \ti{t}{a_3}$, $l_1 = l_2$,
    and $\satisfies{\phi_1,\ti{t}{a_3},(= a_3\;(binop\;a_1\;a_2))}{ti_2^{*}\;l_2}{\phi_2}$.

    %% testop
    If $C \vdash t.testop : ti_1^{*};l_1;\phi_1 \rightarrow ti_2^{*};l_2;\phi_2$,
    then $ti_1^{*} = ti^{*} \; \ti{t}{a_1}$, $ti_2^{*} = ti^{*} \; \ti{\<ithreetwo>}{a_2}$, $l_1 = l_2$,
    and $\satisfies{\phi_1,\ti{\<ithreetwo>}{a_2},(= a_2\;(testop\;a_1))}{ti_2^{*}\;l_2}{\phi_2}$.

    %% relop
    If $C \vdash t.relop : ti_1^{*};l_1;\phi_1 \rightarrow ti_2^{*};l_2;\phi_2$,
    then $ti_1^{*} = ti^{*} \; \ti{t}{a_1} \; \ti{t}{a_2}$, $ti_2^{*} = ti^{*} \; \ti{\<ithreetwo>}{a_3}$, $l_1 = l_2$,
    and $\satisfies{\phi_1,\ti{\<ithreetwo>}{a_3},(= a_3\;(relop\;a_1\;a_2))}{ti_2^{*}\;l_2}{\phi_2}$.

    %% set-local
    If $C \vdash \<setlocal> i : ti_1^{*};l_1;\phi_1 \rightarrow ti_2^{*};l_2;\phi_2$,
    then $ti_1^{*} = ti_2^{*} \; \ti{t}{a}$, $l_2 = l_1 \text{ except } l_2(i) = \ti{t}{a_2}$, $C_\text{local}(i) = t$,
    and $\satisfies{\phi_1,\ti{t}{a_2},(= a_2\;a)}{ti_2^{*}\;l_2}{\phi_2}$.

    %% composition
    If $C \vdash e_1^{*} \; e_2 : ti_1^{*};l_1;\phi_1 \rightarrow ti_2^{*};l_2;\phi_2$,
    then $C \vdash e_1^{*} : ti_1^{*};l_1;\phi_1 \rightarrow ti_3^{*};l_3;\phi_3$,
    $C \vdash e_2 : ti_3^{*};l_3;\phi_3 \rightarrow ti_2^{*};l_2;\phi_4$,
    and $\satisfies{\phi_4}{ti_2^{*}\;l_2}{\phi_2}$.

    \thought{This relys on a bit of a non-obvious idea that even if the precondition is changed through subtyping, the subtyping can be deferred until a later composition.}

    %% admin-program
    If $\vdash_i s;v^{*};e^{*} : ti^{*};l;\phi$,
    then $\vdash s : S$,
    and $S;\epsilon \vdash_i v^{*};e^{*} : ti^{*};l;\phi$.

    %% admin-code
    If $S;(ti^n;l;\phi)^{?} \vdash_i s;v^{*};e^{*} : ti^n;l;\phi$,
    then $(\vdash v : \ti{t}{a};\phi_v)^{*}$,
    and $S;C \vdash e^{*} : \epsilon:\ti{t}{a}^{*};\phi_v^{*} \rightarrow ti^n;l;\phi$,
    where $C = S_{\text{inst}}(i),\text{local} \; t^{*}, \text{return} \; (ti^n;l;\phi)^{?}$.

    %% admin-const
    If $\vdash t.\<const> c : ti;\phi_v$,
    then $ti = \ti{t}{a}$,
    and $\phi_v = \circ,\ti{t}{a},(= a \; \ti{t}{c})$.

    %% local
    If $S;C \vdash \<local> \{ i;v_l^{*} \} \; e^{*} \<end> : ti_1^{*};l_1;\phi_1 \rightarrow ti_2^{*};l_2;\phi_2$,
    then $ti_2^{*} = ti_1^{*} \; ti^n$, $l_1 = l_2$,
    $S;(ti^n;l_3;\phi_3) \vdash_i v_l^{*};e^{*} : ti^n;l_3;\phi_3$,
    and $\satisfies{\phi_1,\phi_3}{ti_2^{*}\;l_2}{\phi_2}$.

\end{lemma}
\begin{proof}
    Proof omitted, but follows from induction over typing derivations.
\end{proof}

\begin{lemma}{(Coherence)}
    \todo{Nested composition can be expressed with only one subtyping relation.}
\end{lemma}
\begin{proof}
\end{proof}

\begin{lemma}{(Nested-Type-Preserved)}

    If $C \vdash v^n : \epsilon;l_3;\phi_3 \rightarrow ti^n;l_3;\phi_4$ is a subderivation of $C \vdash  L^j [v^n] : s_1;l_1;\phi_1 \rightarrow s_2;l_2;\phi_2$,
    \\then $C \vdash v^n : \epsilon;l_1;\phi_1 \rightarrow ti^n;l_3;\phi_4$ after reduction
\end{lemma}
\begin{proof}
    By induction on $j$.
    \begin{itemize}
        \item Base case: $j=0$

            $C \vdash v_0^{*} \; v^n \; e^{*} \<end> : s_1;l_1;\phi_1 \rightarrow s_2;l_2;\phi_2$ for some $v_0^{*}$ and $e^{*}$ by expanding $L^0$.

            $C \vdash (t.\<const> c)^{*} : \epsilon;l_1;\phi_0 \rightarrow \ti{t}{a}^{*};l_1;\phi_0,\ti{t}{a}^{*},(\<eq> a \; \ti{t}{c})$ where $v_0^{*}=(t.\<const> c)^{*}$ and $\phi_1 \implies \phi_0$ by $inversion$.

            Then, $\phi_0,\ti{t}{a}^{*},(\<eq> a \; \ti{t}{c}) \implies \phi_3$.

            $C \vdash v^n : \ti{t}{a}^{*};l_3;\phi_0,\ti{t}{a}^{*},(\<eq> a \; \ti{t}{c}) \rightarrow \ti{t}{a}^{*},\ti{t}{a}^{*}\;ti^n;l_3;\phi_4$, by $subtyping$.

            $C \vdash v^n : \epsilon;l_3;\phi_0,\ti{t}{a}^{*},(\<eq> a \; \ti{t}{c}) \rightarrow \ti{t}{a}^{*}\;ti^n;l_3;\phi_4$, by $inversion$.

            If $v_0^{*}$ are not executed (\ie they are not part of the reduced expression), then $a^{*}$ are fresh, so $\phi_0 \implies \phi_0,\ti{t}{a}^{*},(\<eq> a \; \ti{t}{c})$, and therefore $C \vdash v^n : \epsilon;l_1;\phi_0 \rightarrow ti^n;l_1;\phi_4$ by $subtyping$ and since $l_1=l_3$.

            Then, $C \vdash v^n : \epsilon;l_1;\phi_1 \rightarrow ti^n;l_1;\phi_4$ by $subtyping$.

        \item Induction case: $j=k+1$

            $C \vdash \<label>_n \{ e_0^{*} \} \; v_0^{*} \; L^k[v^n] \; e_1^{*} \<end> : s_1;l_1;\phi_1 \rightarrow s_2;l_2;\phi_2$ for some $v_0^{*}$, $e_0^{*}$, and $e_1^{*}$ by expanding $L^j$.

            $C \vdash (t.\<const> c)^{*} : \epsilon;l_1;\phi_0 \rightarrow \ti{t}{a}^{*};l_1;\phi_0,\ti{t}{a}^{*},(\<eq> a \; \ti{t}{c})$ where $v_0^{*}=(t.\<const> c)^{*}$ and $\phi_1 \implies \phi_0$ by $inversion$.

            Then, $C \vdash L^k[v^n] : \ti{t}{a}^{*};l_1;\phi_0,\ti{t}{a}^{*},(\<eq> a \; \ti{t}{c}) \rightarrow s_5;l_5;\phi_5$ for some $s_5;l_5;\phi_5$ by $inversion$.

            $C \vdash v^n : \epsilon;l_1;\phi_0,\ti{t}{a}^{*},(\<eq> a \; \ti{t}{c}) \rightarrow ti^n;l_1;\phi_4$ by the inductive hypothesis.

            If $v_0^{*}$ are not executed (\ie after one reduction step), $a^{*}$ are fresh, so $\phi_0 \implies \ti{t}{a}^{*},(\<eq> a \; \ti{t}{c})$, and therefore $C \vdash v^n : \epsilon;l_1;\phi_0 \rightarrow \ti{t}{a}^{*}\;ti^n;l_3;\phi_5$ by $subtyping$ and since $l_1=l_3$.

            Then, $C \vdash v^n : \epsilon;l_1;\phi_1 \rightarrow \ti{t}{a}^{*}\;ti^n;l_3;\phi_3$ by $subtyping$.

    \end{itemize}
\end{proof}
